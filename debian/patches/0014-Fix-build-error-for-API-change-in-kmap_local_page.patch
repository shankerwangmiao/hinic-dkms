From 650aa72784faaeaf165cb2cf05ca7c961100929d Mon Sep 17 00:00:00 2001
From: Miao Wang <shankerwangmiao@gmail.com>
Date: Fri, 11 Jul 2025 04:33:44 +0800
Subject: [PATCH] Fix build error for API change in kmap_local_page

---
 hinic/Makefile                       |  2 ++
 hinic/feature_test_kmap_local_page.c |  8 ++++++++
 hinic/hinic_tx.c                     | 13 +++++++++++++
 3 files changed, 23 insertions(+)
 create mode 100644 hinic/feature_test_kmap_local_page.c

diff --git a/hinic/Makefile b/hinic/Makefile
index 156895d..c51e517 100644
--- a/hinic/Makefile
+++ b/hinic/Makefile
@@ -15,6 +15,7 @@ $(obj)/hinic_ethtool.o \
 $(obj)/hinic_dbgtool_knl.o \
 $(obj)/hinic_nictool.o \
 $(obj)/hinic_main.o \
+$(obj)/hinic_tx.o \
 	: $(obj)/feature_test.h
 
 feature_test := \
@@ -23,6 +24,7 @@ feature_test := \
 	napi_add_tx_weight \
 	ethtool_get_ringparam_four \
 	eth_hw_addr_set \
+	kmap_local_page \
 
 $(obj)/feature_test.h: $(addsuffix .c,$(addprefix $(src)/feature_test_,$(feature_test)))
 	echo "/* This file is automatically generated. Do not edit. */" > $@
diff --git a/hinic/feature_test_kmap_local_page.c b/hinic/feature_test_kmap_local_page.c
new file mode 100644
index 0000000..04dd1bc
--- /dev/null
+++ b/hinic/feature_test_kmap_local_page.c
@@ -0,0 +1,8 @@
+#include <linux/highmem.h>
+
+void test(void);
+
+void test(void) {
+    static struct page pg = {};
+    kmap_local_page(&pg);
+}
diff --git a/hinic/hinic_tx.c b/hinic/hinic_tx.c
index cd4cce0..88f9094 100644
--- a/hinic/hinic_tx.c
+++ b/hinic/hinic_tx.c
@@ -41,6 +41,8 @@
 #include "hinic_tx.h"
 #include "hinic_dbg.h"
 
+#include "feature_test.h"
+
 #define MIN_SKB_LEN		32
 #define MAX_PAYLOAD_OFFSET	221
 
@@ -53,6 +55,17 @@
 	u64_stats_update_end(&(txq)->txq_stats.syncp);	\
 }
 
+#ifndef HAVE_KMAP_LOCAL_PAGE
+static inline void *kmap_local_page(struct page *page)
+{
+	return kmap_atomic(page);
+}
+static inline void kunmap_local(void *addr)
+{
+	kunmap_atomic(addr);
+}
+#endif
+
 void hinic_txq_get_stats(struct hinic_txq *txq,
 			 struct hinic_txq_stats *stats)
 {
-- 
2.49.0

