From f52db3580e6a415c0385981f49819a7324b1b2b8 Mon Sep 17 00:00:00 2001
From: Miao Wang <shankerwangmiao@gmail.com>
Date: Fri, 11 Jul 2025 04:23:31 +0800
Subject: [PATCH] Fix build error for API change in eth_hw_addr_set

---
 hinic/Makefile                       |  1 +
 hinic/feature_test_eth_hw_addr_set.c | 10 ++++++++++
 hinic/hinic_main.c                   |  7 +++++++
 3 files changed, 18 insertions(+)
 create mode 100644 hinic/feature_test_eth_hw_addr_set.c

diff --git a/hinic/Makefile b/hinic/Makefile
index 156465d..156895d 100644
--- a/hinic/Makefile
+++ b/hinic/Makefile
@@ -22,6 +22,7 @@ feature_test := \
 	add_class_one \
 	napi_add_tx_weight \
 	ethtool_get_ringparam_four \
+	eth_hw_addr_set \
 
 $(obj)/feature_test.h: $(addsuffix .c,$(addprefix $(src)/feature_test_,$(feature_test)))
 	echo "/* This file is automatically generated. Do not edit. */" > $@
diff --git a/hinic/feature_test_eth_hw_addr_set.c b/hinic/feature_test_eth_hw_addr_set.c
new file mode 100644
index 0000000..d1169d5
--- /dev/null
+++ b/hinic/feature_test_eth_hw_addr_set.c
@@ -0,0 +1,10 @@
+#include <linux/netdevice.h>
+#include <linux/etherdevice.h>
+
+void test(void);
+
+void test(void) {
+    static struct net_device netdev = {};
+    static u8 addr[6] = {};
+    eth_hw_addr_set(&netdev, addr);
+}
diff --git a/hinic/hinic_main.c b/hinic/hinic_main.c
index 1f45ced..b41f084 100644
--- a/hinic/hinic_main.c
+++ b/hinic/hinic_main.c
@@ -185,6 +185,13 @@ enum hinic_rx_buff_len {
 #define netif_napi_add_tx_weight netif_tx_napi_add
 #endif
 
+#ifndef HAVE_ETH_HW_ADDR_SET
+static inline void eth_hw_addr_set(struct net_device *dev, const u8 *addr)
+{
+	memcpy(dev->dev_addr, addr, ETH_ALEN);
+}
+#endif
+
 static int hinic_netdev_event(struct notifier_block *notifier,
 		       unsigned long event, void *ptr)
 {
-- 
2.49.0

