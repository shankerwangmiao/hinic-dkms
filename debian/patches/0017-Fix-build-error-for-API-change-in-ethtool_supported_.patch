From: Miao Wang <shankerwangmiao@gmail.com>
Date: Fri, 11 Jul 2025 05:18:35 +0800
Subject: Fix build error for API change in ethtool_supported_coalesce_params

---
 hinic/Makefile                                         | 1 +
 hinic/feature_test_ethtool_supported_coalesce_params.c | 6 ++++++
 hinic/hinic_ethtool.c                                  | 4 ++++
 3 files changed, 11 insertions(+)
 create mode 100644 hinic/feature_test_ethtool_supported_coalesce_params.c

diff --git a/hinic/Makefile b/hinic/Makefile
index c98988f..e797d8f 100644
--- a/hinic/Makefile
+++ b/hinic/Makefile
@@ -28,6 +28,7 @@ feature_test := \
 	kmap_local_page \
 	ethtool_get_coalesce_four \
 	ndo_tx_timeout_two \
+	ethtool_supported_coalesce_params \
 
 $(obj)/feature_test_%.result: $(src)/feature_test_%.c
 	$(Q)echo "Checking feature test for $*..."; \
diff --git a/hinic/feature_test_ethtool_supported_coalesce_params.c b/hinic/feature_test_ethtool_supported_coalesce_params.c
new file mode 100644
index 0000000..13280d4
--- /dev/null
+++ b/hinic/feature_test_ethtool_supported_coalesce_params.c
@@ -0,0 +1,6 @@
+#include <linux/ethtool.h>
+
+extern struct ethtool_ops test;
+struct ethtool_ops test = {
+	.supported_coalesce_params = 0,
+};
diff --git a/hinic/hinic_ethtool.c b/hinic/hinic_ethtool.c
index 37f5f15..5e5e218 100644
--- a/hinic/hinic_ethtool.c
+++ b/hinic/hinic_ethtool.c
@@ -2431,8 +2431,10 @@ static int hinic_set_rxfh_compat(struct net_device *netdev, const u32 *indir,
 #endif
 
 static const struct ethtool_ops hinic_ethtool_ops = {
+#ifdef HAVE_ETHTOOL_SUPPORTED_COALESCE_PARAMS
 	.supported_coalesce_params = ETHTOOL_COALESCE_USECS |
 				     ETHTOOL_COALESCE_PKT_RATE_RX_USECS,
+#endif
 	.get_link_ksettings = hinic_get_link_ksettings,
 	.set_link_ksettings = hinic_set_link_ksettings,
 	.get_drvinfo = hinic_get_drvinfo,
@@ -2471,11 +2473,13 @@ static const struct ethtool_ops hinic_ethtool_ops = {
 };
 
 static const struct ethtool_ops hinicvf_ethtool_ops = {
+#ifdef HAVE_ETHTOOL_SUPPORTED_COALESCE_PARAMS
 	.supported_coalesce_params = ETHTOOL_COALESCE_USECS |
 				     ETHTOOL_COALESCE_MAX_FRAMES |
 				     ETHTOOL_COALESCE_USECS_LOW_HIGH |
 				     ETHTOOL_COALESCE_MAX_FRAMES_LOW_HIGH |
 				     ETHTOOL_COALESCE_PKT_RATE_RX_USECS,
+#endif
 	.get_link_ksettings = hinic_get_link_ksettings,
 	.get_drvinfo = hinic_get_drvinfo,
 	.get_msglevel = hinic_get_msglevel,
