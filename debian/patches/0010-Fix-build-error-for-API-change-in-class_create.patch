From dc2053cb109e81741415bb50d540ce6625f3cefd Mon Sep 17 00:00:00 2001
From: Miao Wang <shankerwangmiao@gmail.com>
Date: Fri, 11 Jul 2025 00:35:45 +0800
Subject: [PATCH] Fix build error for API change in class_create

---
 hinic/Makefile                     | 3 +++
 hinic/feature_test_add_class_one.c | 7 +++++++
 hinic/hinic_dbgtool_knl.c          | 8 +++++++-
 hinic/hinic_nictool.c              | 8 +++++++-
 4 files changed, 24 insertions(+), 2 deletions(-)
 create mode 100644 hinic/feature_test_add_class_one.c

diff --git a/hinic/Makefile b/hinic/Makefile
index 91d7eca..cf60d3f 100644
--- a/hinic/Makefile
+++ b/hinic/Makefile
@@ -12,10 +12,13 @@ hinic-y := hinic_nic_cfg.o hinic_nic_io.o hinic_nic_dbg.o \
            hinic_ethtool.o
 
 $(obj)/hinic_ethtool.o \
+$(obj)/hinic_dbgtool_knl.o \
+$(obj)/hinic_nictool.o \
 	: $(obj)/feature_test.h
 
 feature_test := \
 	struct_rxfh \
+	add_class_one \
 
 $(obj)/feature_test.h: $(addsuffix .c,$(addprefix $(src)/feature_test_,$(feature_test)))
 	echo "/* This file is automatically generated. Do not edit. */" > $@
diff --git a/hinic/feature_test_add_class_one.c b/hinic/feature_test_add_class_one.c
new file mode 100644
index 0000000..10db7fd
--- /dev/null
+++ b/hinic/feature_test_add_class_one.c
@@ -0,0 +1,7 @@
+#include <linux/device.h>
+
+int test(void);
+
+int test(void){
+    return class_create("test") == 0;
+}
diff --git a/hinic/hinic_dbgtool_knl.c b/hinic/hinic_dbgtool_knl.c
index 08aa1d7..90ae066 100644
--- a/hinic/hinic_dbgtool_knl.c
+++ b/hinic/hinic_dbgtool_knl.c
@@ -36,6 +36,8 @@
 #include "hinic_lld.h"
 #include "hinic_dbgtool_knl.h"
 
+#include "feature_test.h"
+
 struct ffm_intr_info {
 	u8 node_id;
 	/* error level of the interrupt source */
@@ -789,7 +791,11 @@ int hinic_dbgtool_knl_init(void *vhwdev, void *chip_node)
 	}
 
 	/*lint -save -e160*/
-	dbgtool_d_class = class_create(CLASS_DBGTOOL);
+	dbgtool_d_class = class_create(
+#ifndef HAVE_ADD_CLASS_ONE
+		THIS_MODULE,
+#endif
+		CLASS_DBGTOOL);
 	/*lint -restore*/
 	if (IS_ERR(dbgtool_d_class)) {
 		pr_err("Create dgbtool class fail\n");
diff --git a/hinic/hinic_nictool.c b/hinic/hinic_nictool.c
index 1882a94..bd29b65 100644
--- a/hinic/hinic_nictool.c
+++ b/hinic/hinic_nictool.c
@@ -32,6 +32,8 @@
 #include "hinic_dcb.h"
 #include "hinic_dbgtool_knl.h"
 
+#include "feature_test.h"
+
 #define HIADM_DEV_PATH		"/dev/nictool_dev"
 #define HIADM_DEV_CLASS		"nictool_class"
 #define HIADM_DEV_NAME		"nictool_dev"
@@ -2427,7 +2429,11 @@ int hinic_tool_k_init(void)
 
 	/* Create equipment */
 	/*lint -save -e160*/
-	g_nictool_class = class_create(HIADM_DEV_CLASS);
+	g_nictool_class = class_create(
+#ifndef HAVE_ADD_CLASS_ONE
+		THIS_MODULE,
+#endif
+		HIADM_DEV_CLASS);
 	/*lint -restore*/
 	if (IS_ERR(g_nictool_class)) {
 		pr_err("Create nictool_class fail\n");
-- 
2.49.0

