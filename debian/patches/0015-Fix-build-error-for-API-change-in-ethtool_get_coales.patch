From 89a6c2c357a7d4d5d1e63e587e786368c6ac4eb7 Mon Sep 17 00:00:00 2001
From: Miao Wang <shankerwangmiao@gmail.com>
Date: Fri, 11 Jul 2025 04:44:32 +0800
Subject: [PATCH] Fix build error for API change in ethtool_get_coalesce

---
 hinic/Makefile                                 |  1 +
 hinic/feature_test_ethtool_get_coalesce_four.c | 12 ++++++++++++
 hinic/hinic_ethtool.c                          | 16 ++++++++++++----
 3 files changed, 25 insertions(+), 4 deletions(-)
 create mode 100644 hinic/feature_test_ethtool_get_coalesce_four.c

diff --git a/hinic/Makefile b/hinic/Makefile
index c51e517..a53d984 100644
--- a/hinic/Makefile
+++ b/hinic/Makefile
@@ -25,6 +25,7 @@ feature_test := \
 	ethtool_get_ringparam_four \
 	eth_hw_addr_set \
 	kmap_local_page \
+	ethtool_get_coalesce_four \
 
 $(obj)/feature_test.h: $(addsuffix .c,$(addprefix $(src)/feature_test_,$(feature_test)))
 	echo "/* This file is automatically generated. Do not edit. */" > $@
diff --git a/hinic/feature_test_ethtool_get_coalesce_four.c b/hinic/feature_test_ethtool_get_coalesce_four.c
new file mode 100644
index 0000000..9ce99c4
--- /dev/null
+++ b/hinic/feature_test_ethtool_get_coalesce_four.c
@@ -0,0 +1,12 @@
+#include <linux/netdevice.h>
+#include <linux/ethtool.h>
+
+
+extern int foo_get_coalesce(struct net_device *,
+			    struct ethtool_coalesce *,
+			    struct kernel_ethtool_coalesce *,
+			    struct netlink_ext_ack *);
+
+struct ethtool_ops foo = {
+	.get_coalesce = foo_get_coalesce,
+};
diff --git a/hinic/hinic_ethtool.c b/hinic/hinic_ethtool.c
index 5684331..37f5f15 100644
--- a/hinic/hinic_ethtool.c
+++ b/hinic/hinic_ethtool.c
@@ -1501,17 +1501,25 @@ static int __hinic_set_coalesce(struct net_device *netdev,
 }
 
 static int hinic_get_coalesce(struct net_device *netdev,
-			      struct ethtool_coalesce *coal,
+			      struct ethtool_coalesce *coal
+#ifdef HAVE_ETHTOOL_GET_COALESCE_FOUR
+			      ,
 			      struct kernel_ethtool_coalesce *kernel_coal,
-			      struct netlink_ext_ack *extack)
+			      struct netlink_ext_ack *extack
+#endif
+)
 {
 	return __hinic_get_coalesce(netdev, coal, COALESCE_ALL_QUEUE);
 }
 
 static int hinic_set_coalesce(struct net_device *netdev,
-			      struct ethtool_coalesce *coal,
+			      struct ethtool_coalesce *coal
+#ifdef HAVE_ETHTOOL_GET_COALESCE_FOUR
+			      ,
 			      struct kernel_ethtool_coalesce *kernel_coal,
-			      struct netlink_ext_ack *extack)
+			      struct netlink_ext_ack *extack
+#endif
+)
 {
 	return __hinic_set_coalesce(netdev, coal, COALESCE_ALL_QUEUE);
 }
-- 
2.49.0

