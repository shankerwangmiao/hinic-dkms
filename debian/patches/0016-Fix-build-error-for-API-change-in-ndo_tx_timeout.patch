From 6aea4391a346d782ec9e41973e7f1674385bdd0e Mon Sep 17 00:00:00 2001
From: Miao Wang <shankerwangmiao@gmail.com>
Date: Fri, 11 Jul 2025 05:06:10 +0800
Subject: [PATCH] Fix build error for API change in ndo_tx_timeout

---
 hinic/Makefile                          | 1 +
 hinic/feature_test_ndo_tx_timeout_two.c | 7 +++++++
 hinic/hinic_main.c                      | 6 +++++-
 3 files changed, 13 insertions(+), 1 deletion(-)
 create mode 100644 hinic/feature_test_ndo_tx_timeout_two.c

diff --git a/hinic/Makefile b/hinic/Makefile
index a53d984..1086ac3 100644
--- a/hinic/Makefile
+++ b/hinic/Makefile
@@ -26,6 +26,7 @@ feature_test := \
 	eth_hw_addr_set \
 	kmap_local_page \
 	ethtool_get_coalesce_four \
+	ndo_tx_timeout_two \
 
 $(obj)/feature_test.h: $(addsuffix .c,$(addprefix $(src)/feature_test_,$(feature_test)))
 	echo "/* This file is automatically generated. Do not edit. */" > $@
diff --git a/hinic/feature_test_ndo_tx_timeout_two.c b/hinic/feature_test_ndo_tx_timeout_two.c
new file mode 100644
index 0000000..7aff72a
--- /dev/null
+++ b/hinic/feature_test_ndo_tx_timeout_two.c
@@ -0,0 +1,7 @@
+#include <linux/netdevice.h>
+
+extern void foo_tx_timeout(struct net_device *netdev, unsigned int txqueue);
+
+struct net_device_ops foo = {
+	.ndo_tx_timeout = foo_tx_timeout,
+};
diff --git a/hinic/hinic_main.c b/hinic/hinic_main.c
index b41f084..23c159b 100644
--- a/hinic/hinic_main.c
+++ b/hinic/hinic_main.c
@@ -1242,7 +1242,11 @@ static void hinic_get_stats64(struct net_device *netdev,
 	stats->rx_dropped = dropped;
 }
 
-static void hinic_tx_timeout(struct net_device *netdev, unsigned int txqueue)
+static void hinic_tx_timeout(struct net_device *netdev
+#ifdef HAVE_NDO_TX_TIMEOUT_TWO
+	, unsigned int txqueue
+#endif
+)
 {
 	struct hinic_nic_dev *nic_dev = netdev_priv(netdev);
 	u16 msix_idx;
-- 
2.49.0

