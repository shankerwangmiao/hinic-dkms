From: Miao Wang <shankerwangmiao@gmail.com>
Date: Sun, 4 Jan 2026 21:22:04 +0800
Subject: Add feature test system

Forwarded: not-needed
---
 hinic/Makefile                   | 34 ++++++++++++++++++++++++++++++++++
 hinic/feature_test_always_true.c |  5 +++++
 2 files changed, 39 insertions(+)
 create mode 100644 hinic/feature_test_always_true.c

diff --git a/hinic/Makefile b/hinic/Makefile
index 7a1e203..1f68cee 100644
--- a/hinic/Makefile
+++ b/hinic/Makefile
@@ -10,3 +10,37 @@ hinic-y := hinic_nic_cfg.o hinic_nic_io.o hinic_nic_dbg.o \
            hinic_qp.o hinic_rx.o hinic_tx.o hinic_dbgtool_knl.o \
            hinic_nictool.o hinic_sriov.o hinic_dcb.o\
            hinic_ethtool.o
+
+feature_test := \
+	always_true \
+
+$(obj)/feature_test_%.result: $(src)/feature_test_%.c
+	$(Q)echo "Checking feature test for $*..."; \
+	if env - PATH=$$PATH $(MAKE) -C "$(objtree)" M="$(M)" "feature_test_$*.o" "obj-y+=feature_test_$*.o" ; then \
+		echo "$*: yes"; \
+		echo "Y" > $@; \
+	elif [ "$*" = "always_true" ] ; then \
+		echo "Problem with feature test"; \
+		exit 1; \
+	else \
+		echo "$*: no"; \
+		echo "N" > $@; \
+	fi; \
+	rm -f "$(obj)/feature_test_$*.o";
+
+$(obj)/feature_test.h: $(addsuffix .result,$(addprefix $(obj)/feature_test_,$(feature_test)))
+	$(Q)echo "/* This file is automatically generated. Do not edit. */" > $@.tmp
+	$(Q)for i in $^; do \
+		basename=$$(basename -- $$i .result); \
+		result=$$(cat $$i); \
+		if [ "$$result" = "Y" ] ; then \
+			echo "#define HAVE_$$(echo "$$basename" | sed 's/feature_test_//; s/.*/\U&/')" >> $@.tmp; \
+		else \
+			echo "/* #undef HAVE_$$(echo "$$basename" | sed 's/feature_test_//; s/.*/\U&/') */" >> $@.tmp; \
+		fi; \
+		echo "" >> $@.tmp; \
+	done
+	mv $@.tmp $@
+
+clean-files += feature_test.h
+clean-files += $(addsuffix .result,$(addprefix feature_test_,$(feature_test)))
diff --git a/hinic/feature_test_always_true.c b/hinic/feature_test_always_true.c
new file mode 100644
index 0000000..de1fed1
--- /dev/null
+++ b/hinic/feature_test_always_true.c
@@ -0,0 +1,5 @@
+int test(void);
+
+int test(void){
+    return 0;
+}
