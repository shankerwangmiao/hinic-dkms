From: Miao Wang <shankerwangmiao@gmail.com>
Date: Fri, 11 Jul 2025 00:52:08 +0800
Subject: Fix build error for API change in netif_napi_add

---
 hinic/Makefile                          |  2 ++
 hinic/feature_test_napi_add_tx_weight.c | 10 ++++++++++
 hinic/hinic_main.c                      |  6 ++++++
 3 files changed, 18 insertions(+)
 create mode 100644 hinic/feature_test_napi_add_tx_weight.c

diff --git a/hinic/Makefile b/hinic/Makefile
index b454f27..f996a53 100644
--- a/hinic/Makefile
+++ b/hinic/Makefile
@@ -14,12 +14,14 @@ hinic-y := hinic_nic_cfg.o hinic_nic_io.o hinic_nic_dbg.o \
 $(obj)/hinic_ethtool.o \
 $(obj)/hinic_dbgtool_knl.o \
 $(obj)/hinic_nictool.o \
+$(obj)/hinic_main.o \
 	: $(obj)/feature_test.h
 
 feature_test := \
 	always_true \
 	struct_rxfh \
 	add_class_one \
+	napi_add_tx_weight \
 
 $(obj)/feature_test_%.result: $(src)/feature_test_%.c
 	$(Q)echo "Checking feature test for $*..."; \
diff --git a/hinic/feature_test_napi_add_tx_weight.c b/hinic/feature_test_napi_add_tx_weight.c
new file mode 100644
index 0000000..aa827fc
--- /dev/null
+++ b/hinic/feature_test_napi_add_tx_weight.c
@@ -0,0 +1,10 @@
+#include <linux/netdevice.h>
+
+extern int foo_poll(struct napi_struct *, int);
+void test(void);
+
+void test(void) {
+    static struct net_device netdev = {};
+    static struct napi_struct napi = {};
+    netif_napi_add_tx_weight(&netdev, &napi, foo_poll, 0);
+}
diff --git a/hinic/hinic_main.c b/hinic/hinic_main.c
index af35cdb..1f45ced 100644
--- a/hinic/hinic_main.c
+++ b/hinic/hinic_main.c
@@ -45,6 +45,8 @@
 #include "hinic_sriov.h"
 #include "hinic_pci_id_tbl.h"
 
+#include "feature_test.h"
+
 static u16 num_qps;
 module_param(num_qps, ushort, 0444);
 MODULE_PARM_DESC(num_qps, "Number of Queue Pairs (default unset)");
@@ -179,6 +181,10 @@ enum hinic_rx_buff_len {
 					 NETIF_F_SCTP_CRC | NETIF_F_RXCSUM | \
 					 NETIF_F_ALL_TSO)
 
+#ifndef HAVE_NAPI_ADD_TX_WEIGHT
+#define netif_napi_add_tx_weight netif_tx_napi_add
+#endif
+
 static int hinic_netdev_event(struct notifier_block *notifier,
 		       unsigned long event, void *ptr)
 {
